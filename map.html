<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotas — Visão Aérea</title>
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
  <style>
    html, body { height:100%; margin:0; }
    #map { position:fixed; inset:0; }
    .topbar {
      position:fixed; top:10px; left:10px; right:10px;
      display:flex; gap:8px; align-items:center; z-index:5; flex-wrap:wrap;
      font:14px system-ui;
    }
    .tag { background:rgba(0,0,0,.6); color:#fff; padding:6px 10px; border-radius:10px; }
    .btn { background:#ffd400; border:0; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; color:#000; text-decoration:none; }
    .err { background:#B00020; color:#fff; }
    .marker {
      width: 28px; height: 28px; border-radius: 50%;
      background: #ffd400; color:#000; font-weight:800; display:flex; align-items:center; justify-content:center;
      border: 2px solid #000; box-shadow: 0 1px 4px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
  <div id="map" role="application" aria-label="Mapa de rotas"></div>
  <div class="topbar">
    <div id="title" class="tag">Carregando rota…</div>
    <button id="toggle" class="btn" style="display:none;">Mostrar trajeto</button>
    <a class="btn" href="./index.html">Voltar</a>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const params = new URLSearchParams(location.search);
    const routeParam = (params.get('r') || '').trim().toLowerCase();

    // Carto Positron
    const osmStyle = {
      "version": 8,
      "name": "Carto Positron",
      "sources": {
        "carto": {
          "type": "raster",
          "tiles": ["https://basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"],
          "tileSize": 256,
          "attribution": "© OpenStreetMap contributors © CARTO"
        }
      },
      "layers": [
        { "id": "bk", "type": "background", "paint": { "background-color": "#f8f8f8" } },
        { "id": "carto", "type": "raster", "source": "carto", "minzoom": 0, "maxzoom": 20 }
      ]
    };

    const map = new maplibregl.Map({
      container: 'map',
      style: osmStyle,
      center: [-46.6333, -23.5505],
      zoom: 13
    });

    let visible = false;

    fetch('routes.json?v=' + Date.now(), { cache: 'no-store' })
      .then(r => {
        if (!r.ok) throw new Error(`Falha ao carregar routes.json (${r.status})`);
        return r.json();
      })
      .then(data => {
        if (!data || !Array.isArray(data.routes) || data.routes.length === 0) {
          throw new Error('routes.json inválido/vazio. Esperado { "routes": [ ... ] }.');
        }

        const wanted = data.routes.find(rt => (rt.id||'').trim().toLowerCase() === routeParam);
        const picked = wanted || data.routes[0];
        $('title').textContent = picked.title || 'Rota';

        // =======================
        // usa path "assado" (Feature GeoJSON) se existir;
        // senão, aceita path.coordinates (formato antigo);
        // senão, liga os stops.
        // =======================
        let lineFeature = null;

        if (picked.path?.geometry?.type === 'LineString' &&
            Array.isArray(picked.path.geometry.coordinates)) {
          // path já vem como Feature GeoJSON completo
          lineFeature = picked.path;
        } else if (Array.isArray(picked.path?.coordinates)) {
          // compat: path.coordinates direto
          lineFeature = {
            type: "Feature",
            properties: {},
            geometry: { type: "LineString", coordinates: picked.path.coordinates }
          };
        } else {
          // fallback: conecta as paradas
          const stopsCoords = (picked.stops || []).map(s => s.coord).filter(Boolean);
          if (!stopsCoords || stopsCoords.length < 2) {
            throw new Error('Não há coordenadas suficientes para desenhar a linha (verifique path.geometry.coordinates ou stops.coord).');
          }
          lineFeature = {
            type: "Feature",
            properties: {},
            geometry: { type: "LineString", coordinates: stopsCoords }
          };
        }

        const lineCoords = lineFeature.geometry.coordinates;

        map.on('load', () => {
          // Fonte/camada da linha
          if (map.getSource('route')) map.removeSource('route');
          map.addSource('route', { type:'geojson', data: lineFeature });

          if (map.getLayer('route-line')) map.removeLayer('route-line');
          map.addLayer({
            id:'route-line',
            type:'line',
            source:'route',
            layout:{ 'line-cap':'round', 'line-join':'round' },
            paint:{
              'line-color': picked.color || '#1E88E5',
              'line-width': 6,
              'line-opacity': 0.0
            }
          });

          // Marcadores dos stops (numerados + popup)
          (picked.stops || []).forEach((s, i) => {
            if (!s.coord) return;
            const el = document.createElement('div');
            el.className = 'marker';
            el.textContent = String(i+1);
            new maplibregl.Marker({ element: el, anchor: 'center' })
              .setLngLat(s.coord)
              .setPopup(new maplibregl.Popup({ offset: 28 }).setText(s.name || `Ponto ${i+1}`))
              .addTo(map);
          });

          // Fit bounds na linha assada
          const bbox = computeBounds(lineCoords);
          map.fitBounds([[bbox.minLng, bbox.minLat], [bbox.maxLng, bbox.maxLat]], { padding: 80, duration: 600 });

          // Toggle visibilidade
          const btn = $('toggle');
          btn.style.display = 'inline-block';
          btn.textContent = 'Mostrar trajeto';
          btn.onclick = () => {
            visible = !visible;
            map.setPaintProperty('route-line', 'line-opacity', visible ? 1.0 : 0.0);
            btn.textContent = visible ? 'Ocultar trajeto' : 'Mostrar trajeto';
          };

          // Primeira interação também revela
          map.getCanvas().addEventListener('click', () => {
            if (!visible) btn.click();
          }, { once:true });
        });
      })
      .catch(err => {
        $('title').classList.add('err');
        $('title').textContent = 'Erro: ' + (err.message || 'Falha ao carregar');
        console.error('[map.html]', err);
      });

    function computeBounds(coords) {
      let minLng = +Infinity, minLat = +Infinity, maxLng = -Infinity, maxLat = -Infinity;
      for (const c of coords) {
        const lng = Number(c[0]); const lat = Number(c[1]);
        if (!isFinite(lng) || !isFinite(lat)) continue;
        if (lng < minLng) minLng = lng;
        if (lng > maxLng) maxLng = lng;
        if (lat < minLat) minLat = lat;
        if (lat > maxLat) maxLat = lat;
      }
      return { minLng, minLat, maxLng, maxLat };
    }

    map.on('error', (e) => console.error('[MapLibre error]', e && e.error || e));
  </script>
</body>
</html>
